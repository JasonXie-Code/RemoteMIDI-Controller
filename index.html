<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>üéπ Mobile MIDI Controller</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            height: 100vh;
            overflow: hidden;
            touch-action: none;
        }

        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            padding: 10px;
        }

        .header {
            text-align: center;
            padding: 10px 0;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .title {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .sensitivity-button {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            cursor: pointer;
            margin: 5px 0;
            transition: all 0.2s ease;
            -webkit-tap-highlight-color: transparent;
        }

        .sensitivity-button:hover,
        .sensitivity-button:active {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(0.98);
        }

        .status {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            font-size: 0.9em;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #ff4444;
        }

        .status-dot.connected {
            background: #44ff44;
            box-shadow: 0 0 10px #44ff44;
        }

        .control-area {
            flex: 1;
            display: flex;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 15px;
            overflow: hidden;
            position: relative;
        }

        .left-margin {
            width: 25%;
            background: rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 20px;
            position: relative;
            border-right: 2px solid rgba(255, 255, 255, 0.6);
        }

        .left-margin::after {
            content: '';
            position: absolute;
            top: 50%;
            right: -2px;
            width: 2px;
            height: 60%;
            background: rgba(255, 255, 255, 0.5);
            transform: translateY(-50%);
        }

        .margin-label {
            writing-mode: vertical-rl;
            text-orientation: mixed;
            font-size: 0.8em;
            opacity: 0.7;
            text-align: center;
        }

        .xy-pad {
            flex: 1;
            position: relative;
            background: linear-gradient(to bottom, 
                rgba(255, 100, 100, 0.3) 0%, 
                rgba(255, 255, 255, 0.1) 50%, 
                rgba(100, 255, 100, 0.3) 100%);
            cursor: crosshair;
            touch-action: none;
        }

        .xy-pad::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 2px;
            background: rgba(255, 255, 255, 0.5);
            transform: translateY(-1px);
        }

        .xy-pad::after {
            content: '';
            position: absolute;
            top: 0;
            bottom: 0;
            left: 0;
            width: 2px;
            background: rgba(255, 255, 255, 0.3);
        }

        .active-area-overlay {
            position: absolute;
            border: 2px solid rgba(255, 255, 255, 0.6);
            border-radius: 8px;
            pointer-events: none;
            transition: all 0.2s ease;
            background: rgba(255, 255, 255, 0.05);
        }

        .touch-indicator {
            position: absolute;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.8);
            border: 3px solid rgba(255, 255, 255, 0.5);
            transform: translate(-50%, -50%);
            pointer-events: none;
            display: none;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.6);
        }

        .touch-indicator.active {
            display: block;
            background: rgba(255, 255, 255, 1);
            box-shadow: 0 0 30px rgba(255, 255, 255, 0.8);
        }

        .values-display {
            padding: 15px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 10px;
            margin-top: 10px;
        }

        .value-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-family: 'Courier New', monospace;
        }

        .value-row:last-child {
            margin-bottom: 0;
        }

        .value-label {
            font-weight: bold;
            font-size: 0.9em;
        }

        .value-number {
            font-size: 1.1em;
            padding: 2px 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 5px;
            min-width: 80px;
            text-align: center;
        }

        .pitchbend {
            color: #ffaaaa;
        }

        .modulation {
            color: #aaffaa;
        }

        .sensitivity-display {
            color: #aaaaff;
        }

        /* ÁÅµÊïèÂ∫¶ËÆæÁΩÆÂºπÁ™ó */
        .sensitivity-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1500;
        }

        .sensitivity-modal-content {
            background: rgba(20, 20, 40, 0.95);
            border-radius: 15px;
            padding: 25px;
            max-width: 350px;
            width: 90%;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .modal-title {
            text-align: center;
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 20px;
            color: white;
        }

        .sensitivity-control-group {
            margin-bottom: 25px;
        }

        .sensitivity-control-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            font-size: 0.95em;
            font-weight: bold;
        }

        .sensitivity-control-value {
            background: rgba(255, 255, 255, 0.2);
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.9em;
            min-width: 50px;
            text-align: center;
        }

        .sensitivity-control-slider {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 5px;
            outline: none;
            -webkit-appearance: none;
        }

        .sensitivity-control-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }

        .sensitivity-control-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            cursor: pointer;
            border: none;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }

        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 25px;
        }

        .modal-button {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            min-width: 80px;
            transition: all 0.2s ease;
            -webkit-tap-highlight-color: transparent;
        }

        .modal-button.primary {
            background: #007acc;
            color: white;
        }

        .modal-button.primary:hover,
        .modal-button.primary:active {
            background: #005c8a;
            transform: scale(0.98);
        }

        .modal-button.secondary {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .modal-button.secondary:hover,
        .modal-button.secondary:active {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(0.98);
        }

        .reconnect-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .reconnect-message {
            background: rgba(255, 255, 255, 0.1);
            padding: 30px;
            border-radius: 15px;
            text-align: center;
        }

        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ÂìçÂ∫îÂºèËÆæËÆ° */
        @media (max-width: 480px) {
            .container {
                padding: 5px;
            }
            
            .title {
                font-size: 1.2em;
            }
            
            .status {
                padding: 0 10px;
                font-size: 0.8em;
            }
            
            .left-margin {
                padding: 10px;
            }
            
            .values-display {
                padding: 10px;
            }

            .sensitivity-modal-content {
                padding: 20px;
                max-width: 320px;
            }
        }

        /* Ê®™Â±èË≠¶Âëä */
        @media (orientation: landscape) {
            .landscape-warning {
                display: block;
            }
        }

        .landscape-warning {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            text-align: center;
            padding: 50px 20px;
            z-index: 2000;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="title">üéπ Mobile MIDI Controller</div>
            <button class="sensitivity-button" id="sensitivityButton">
                ÁÅµÊïèÂ∫¶ËÆæÁΩÆ (ÂºØÈü≥: <span id="pitchSensDisplay">1.0</span>x, Ë∞ÉÂà∂: <span id="modSensDisplay">1.0</span>x)
            </button>
            <div class="status">
                <div class="status-item">
                    <div class="status-dot" id="wsStatus"></div>
                    <span id="wsStatusText">ËøûÊé•‰∏≠...</span>
                </div>
                <div class="status-item">
                    <div class="status-dot" id="midiStatus"></div>
                    <span id="midiStatusText">MIDI</span>
                </div>
            </div>
        </div>

        <div class="control-area">
            <div class="left-margin">
                <div class="margin-label">Ëß¶ÊéßÂå∫Âüü</div>
            </div>
            <div class="xy-pad" id="xyPad">
                <div class="active-area-overlay" id="activeAreaOverlay"></div>
                <div class="touch-indicator" id="touchIndicator"></div>
            </div>
        </div>

        <div class="values-display">
            <div class="value-row">
                <span class="value-label">ÂºØÈü≥ (Pitchbend):</span>
                <span class="value-number pitchbend" id="pitchValue">+0.000</span>
            </div>
            <div class="value-row">
                <span class="value-label">Ë∞ÉÂà∂ (Modulation):</span>
                <span class="value-number modulation" id="modValue">0</span>
            </div>
        </div>
    </div>

    <!-- ÁÅµÊïèÂ∫¶ËÆæÁΩÆÂºπÁ™ó -->
    <div class="sensitivity-modal" id="sensitivityModal">
        <div class="sensitivity-modal-content">
            <div class="modal-title">üéõÔ∏è ÁÅµÊïèÂ∫¶ËÆæÁΩÆ</div>
            
            <div class="sensitivity-control-group">
                <div class="sensitivity-control-label">
                    <span>üéµ ÂºØÈü≥ÁÅµÊïèÂ∫¶</span>
                    <span class="sensitivity-control-value" id="pitchSensValue">1.0x</span>
                </div>
                <input type="range" class="sensitivity-control-slider" id="pitchSensSlider" 
                       min="0.5" max="2.0" step="0.1" value="1.0">
            </div>

            <div class="sensitivity-control-group">
                <div class="sensitivity-control-label">
                    <span>üåä Ë∞ÉÂà∂ÁÅµÊïèÂ∫¶</span>
                    <span class="sensitivity-control-value" id="modSensValue">1.0x</span>
                </div>
                <input type="range" class="sensitivity-control-slider" id="modSensSlider" 
                       min="0.5" max="2.0" step="0.1" value="1.0">
            </div>

            <div class="modal-buttons">
                <button class="modal-button secondary" id="resetSensButton">ÈáçÁΩÆ</button>
                <button class="modal-button primary" id="closeSensButton">Á°ÆÂÆö</button>
            </div>
        </div>
    </div>

    <div class="reconnect-overlay" id="reconnectOverlay">
        <div class="reconnect-message">
            <div class="spinner"></div>
            <div>ÈáçÊñ∞ËøûÊé•‰∏≠...</div>
        </div>
    </div>

    <div class="landscape-warning">
        <h2>üì± ËØ∑Á´ñÂ±è‰ΩøÁî®</h2>
        <p>‰∏∫‰∫ÜÊúÄ‰Ω≥‰ΩìÈ™åÔºåËØ∑Â∞ÜÊâãÊú∫Á´ñÁõ¥ÊîæÁΩÆ‰ΩøÁî®Ê≠§MIDIÊéßÂà∂Âô®</p>
    </div>

    <script>
        class MIDIController {
            constructor() {
                this.ws = null;
                this.isConnected = false;
                this.reconnectAttempts = 0;
                this.maxReconnectAttempts = 5;
                this.reconnectDelay = 1000;
                this.isKickedOut = false; // Ê†áËÆ∞ÊòØÂê¶Ë¢´Ë∏¢‰∏ãÁ∫ø
                
                this.currentPitchbend = 0;
                this.currentModulation = 0;
                this.pitchSensitivity = 1.0; // ÂºØÈü≥ÁÅµÊïèÂ∫¶ÔºåËåÉÂõ¥ 0.5-2.0
                this.modSensitivity = 1.0;   // Ë∞ÉÂà∂ÁÅµÊïèÂ∫¶ÔºåËåÉÂõ¥ 0.5-2.0
                this.isTracking = false;
                this.lastTouchTime = null; // ‰∏äÊ¨°Ëß¶Êë∏Êó∂Èó¥
                
                this.lastSendTime = 0;
                this.sendThrottle = 8; // ~120fps, Êõ¥Âø´ÂìçÂ∫î
                
                // ÊåÅÁª≠ÂèëÈÄÅÂÆöÊó∂Âô®
                this.continuousSendInterval = null;
                this.continuousSendRate = 50; // 20fpsÊåÅÁª≠ÂèëÈÄÅ
                
                this.xyPad = document.getElementById('xyPad');
                this.touchIndicator = document.getElementById('touchIndicator');
                this.activeAreaOverlay = document.getElementById('activeAreaOverlay');
                
                this.initElements();
                this.initWebSocket();
                this.initEventListeners();
                this.startHeartbeat();
                this.startContinuousSend(); // ÂêØÂä®ÊåÅÁª≠ÂèëÈÄÅ
                this.updateActiveArea(); // ÂàùÂßãÂåñÊúâÊïàÂå∫ÂüüÊòæÁ§∫
                this.updateSensitivityDisplay(); // ÂàùÂßãÂåñÁÅµÊïèÂ∫¶ÊòæÁ§∫
            }
            
            initElements() {
                this.wsStatus = document.getElementById('wsStatus');
                this.wsStatusText = document.getElementById('wsStatusText');
                this.midiStatus = document.getElementById('midiStatus');
                this.midiStatusText = document.getElementById('midiStatusText');
                this.pitchValue = document.getElementById('pitchValue');
                this.modValue = document.getElementById('modValue');
                this.reconnectOverlay = document.getElementById('reconnectOverlay');
                
                // ÁÅµÊïèÂ∫¶Áõ∏ÂÖ≥ÂÖÉÁ¥†
                this.sensitivityButton = document.getElementById('sensitivityButton');
                this.sensitivityModal = document.getElementById('sensitivityModal');
                this.pitchSensSlider = document.getElementById('pitchSensSlider');
                this.modSensSlider = document.getElementById('modSensSlider');
                this.pitchSensValue = document.getElementById('pitchSensValue');
                this.modSensValue = document.getElementById('modSensValue');
                this.pitchSensDisplay = document.getElementById('pitchSensDisplay');
                this.modSensDisplay = document.getElementById('modSensDisplay');
                this.resetSensButton = document.getElementById('resetSensButton');
                this.closeSensButton = document.getElementById('closeSensButton');
            }
            
            initWebSocket() {
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${protocol}//${window.location.hostname}:8001`;
                
                console.log('ËøûÊé•WebSocket:', wsUrl);
                this.ws = new WebSocket(wsUrl);
                
                this.ws.onopen = () => {
                    console.log('WebSocketËøûÊé•ÊàêÂäü');
                    this.isConnected = true;
                    this.reconnectAttempts = 0;
                    this.updateConnectionStatus(true);
                    this.hideReconnectOverlay();
                    
                    // ËøûÊé•ÊàêÂäüÂêéÁ´ãÂç≥ÂêØÂä®ÊåÅÁª≠ÂèëÈÄÅ
                    this.startContinuousSend();
                };
                
                this.ws.onclose = () => {
                    console.log('WebSocketËøûÊé•ÂÖ≥Èó≠');
                    this.isConnected = false;
                    this.updateConnectionStatus(false);
                    this.stopContinuousSend(); // ËøûÊé•ÂÖ≥Èó≠Êó∂ÂÅúÊ≠¢ÊåÅÁª≠ÂèëÈÄÅ
                    this.scheduleReconnect();
                };
                
                this.ws.onerror = (error) => {
                    console.error('WebSocketÈîôËØØ:', error);
                    this.isConnected = false;
                    this.updateConnectionStatus(false);
                    this.stopContinuousSend(); // ËøûÊé•Âá∫ÈîôÊó∂ÂÅúÊ≠¢ÊåÅÁª≠ÂèëÈÄÅ
                };
                
                this.ws.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        this.handleMessage(data);
                    } catch (e) {
                        console.error('Ê∂àÊÅØËß£ÊûêÈîôËØØ:', e);
                    }
                };
            }
            
            handleMessage(data) {
                switch (data.type) {
                    case 'status':
                        this.updateMIDIStatus(data.data.midi_connected);
                        break;
                    case 'pong':
                        // ÂøÉË∑≥ÂìçÂ∫î
                        break;
                    case 'disconnect':
                        // Ë¢´ÊúçÂä°Âô®Ë∏¢‰∏ãÁ∫ø
                        console.log('‚ö†Ô∏è Ë¢´Êñ∞ËÆæÂ§áË∏¢‰∏ãÁ∫ø:', data.reason);
                        this.isKickedOut = true; // Ê†áËÆ∞Ë¢´Ë∏¢‰∏ãÁ∫øÔºåÂÅúÊ≠¢ÈáçËøû
                        this.stopContinuousSend(); // ÂÅúÊ≠¢ÊåÅÁª≠ÂèëÈÄÅ
                        this.showKickedMessage(data.reason);
                        break;
                }
            }
            
            showKickedMessage(reason) {
                // ÊòæÁ§∫Ë¢´Ë∏¢‰∏ãÁ∫øÁöÑÊ∂àÊÅØ
                const overlay = document.createElement('div');
                overlay.style.cssText = `
                    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                    background: rgba(0,0,0,0.8); color: white; z-index: 9999;
                    display: flex; align-items: center; justify-content: center;
                    font-size: 18px; text-align: center; padding: 20px;
                    -webkit-user-select: none; user-select: none;
                `;
                overlay.innerHTML = `
                    <div style="max-width: 300px;">
                        <h3 style="margin-bottom: 15px;">‚ö†Ô∏è ËøûÊé•Â∑≤Êñ≠ÂºÄ</h3>
                        <p style="margin-bottom: 15px;">${reason}</p>
                        <p style="margin: 20px 0; font-size: 14px; color: #ccc; line-height: 1.4;">
                            Âè™ÊúâÊúÄÊñ∞ËøûÊé•ÁöÑËÆæÂ§áÂèØ‰ª•ÊéßÂà∂MIDI<br>
                            Â¶ÇÈúÄÈáçÊñ∞ÊéßÂà∂ÔºåËØ∑ÁÇπÂáª‰∏ãÊñπÊåâÈíÆ
                        </p>
                        <div style="margin-top: 25px;">
                            <button id="reconnectBtn" style="
                                padding: 15px 25px; font-size: 16px; 
                                background: #007acc; color: white; 
                                border: none; border-radius: 8px; 
                                cursor: pointer; margin: 0 8px;
                                min-height: 44px; min-width: 120px;
                                touch-action: manipulation;
                                -webkit-appearance: none;
                                -webkit-tap-highlight-color: rgba(0,0,0,0);
                            ">ÈáçÊñ∞ËøûÊé•</button>
                            <button id="closeBtn" style="
                                padding: 15px 25px; font-size: 16px; 
                                background: #666; color: white; 
                                border: none; border-radius: 8px; 
                                cursor: pointer; margin: 0 8px;
                                min-height: 44px; min-width: 120px;
                                touch-action: manipulation;
                                -webkit-appearance: none;
                                -webkit-tap-highlight-color: rgba(0,0,0,0);
                            ">ÂÖ≥Èó≠È°µÈù¢</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(overlay);
                
                // Á≠âÂæÖDOMÊ∏≤ÊüìÂÆåÊàêÂêéÁªëÂÆö‰∫ã‰ª∂
                setTimeout(() => {
                    const reconnectBtn = document.getElementById('reconnectBtn');
                    const closeBtn = document.getElementById('closeBtn');
                    
                    if (reconnectBtn) {
                        // ÈáçÊñ∞ËøûÊé•ÊåâÈíÆ - ÊîØÊåÅÁÇπÂáªÂíåËß¶Êë∏
                        const handleReconnect = (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            console.log('üîÑ Áî®Êà∑ÁÇπÂáªÈáçÊñ∞ËøûÊé•');
                            
                            this.isKickedOut = false; // ÈáçÁΩÆÁä∂ÊÄÅ
                            this.reconnectAttempts = 0; // ÈáçÁΩÆÈáçËøûÊ¨°Êï∞
                            document.body.removeChild(overlay);
                            this.initWebSocket(); // ÈáçÊñ∞ËøûÊé•
                        };
                        
                        reconnectBtn.addEventListener('click', handleReconnect);
                        reconnectBtn.addEventListener('touchstart', handleReconnect, { passive: false });
                        reconnectBtn.addEventListener('touchend', (e) => {
                            e.preventDefault();
                        }, { passive: false });
                        
                        // Ê∑ªÂä†ËßÜËßâÂèçÈ¶à
                        reconnectBtn.addEventListener('touchstart', () => {
                            reconnectBtn.style.background = '#005c8a';
                        });
                        reconnectBtn.addEventListener('touchend', () => {
                            setTimeout(() => {
                                if (reconnectBtn.parentNode) {
                                    reconnectBtn.style.background = '#007acc';
                                }
                            }, 100);
                        });
                    }
                    
                    if (closeBtn) {
                        // ÂÖ≥Èó≠È°µÈù¢ÊåâÈíÆ - ÊîØÊåÅÁÇπÂáªÂíåËß¶Êë∏
                        const handleClose = (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            console.log('‚ùå Áî®Êà∑ÈÄâÊã©ÂÖ≥Èó≠È°µÈù¢');
                            
                            // Â∞ùËØïÂÖ≥Èó≠Á™óÂè£ÔºåÂ¶ÇÊûúÂ§±Ë¥•ÂàôÊòæÁ§∫ÊèêÁ§∫
                            if (window.close) {
                                window.close();
                            }
                            
                            // Â¶ÇÊûúÊó†Ê≥ïÂÖ≥Èó≠Á™óÂè£ÔºåÊòæÁ§∫ÊèêÁ§∫
                            setTimeout(() => {
                                alert('ËØ∑ÊâãÂä®ÂÖ≥Èó≠Ê≠§È°µÈù¢');
                            }, 500);
                        };
                        
                        closeBtn.addEventListener('click', handleClose);
                        closeBtn.addEventListener('touchstart', handleClose, { passive: false });
                        closeBtn.addEventListener('touchend', (e) => {
                            e.preventDefault();
                        }, { passive: false });
                        
                        // Ê∑ªÂä†ËßÜËßâÂèçÈ¶à
                        closeBtn.addEventListener('touchstart', () => {
                            closeBtn.style.background = '#444';
                        });
                        closeBtn.addEventListener('touchend', () => {
                            setTimeout(() => {
                                if (closeBtn.parentNode) {
                                    closeBtn.style.background = '#666';
                                }
                            }, 100);
                        });
                    }
                }, 100);
            }
            
            startContinuousSend() {
                // ÂêØÂä®ÊåÅÁª≠ÂèëÈÄÅÂÆöÊó∂Âô®
                if (this.continuousSendInterval) {
                    clearInterval(this.continuousSendInterval);
                }
                
                this.continuousSendInterval = setInterval(() => {
                    // ÊåÅÁª≠ÂèëÈÄÅÂΩìÂâç‰ΩçÁΩÆÔºåÊó†ËÆ∫ÊòØÂê¶ÊúâËß¶Êë∏
                    this.sendControlData(true); // ‰º†ÂÖ•trueË°®Á§∫ÊòØÊåÅÁª≠ÂèëÈÄÅ
                }, this.continuousSendRate);
                
                console.log('üîÑ ÂêØÂä®ÊåÅÁª≠ÂèëÈÄÅÂÆöÊó∂Âô® (20fps)');
            }
            
            stopContinuousSend() {
                if (this.continuousSendInterval) {
                    clearInterval(this.continuousSendInterval);
                    this.continuousSendInterval = null;
                    console.log('‚ÑπÔ∏è ÂÅúÊ≠¢ÊåÅÁª≠ÂèëÈÄÅÂÆöÊó∂Âô®');
                }
            }
            
            updateConnectionStatus(connected) {
                if (connected) {
                    this.wsStatus.classList.add('connected');
                    this.wsStatusText.textContent = 'Â∑≤ËøûÊé•';
                    this.startContinuousSend(); // ËøûÊé•Êó∂ÂêØÂä®ÊåÅÁª≠ÂèëÈÄÅ
                } else {
                    this.wsStatus.classList.remove('connected');
                    this.wsStatusText.textContent = 'Êñ≠ÂºÄ';
                    this.stopContinuousSend(); // Êñ≠ÂºÄÊó∂ÂÅúÊ≠¢ÊåÅÁª≠ÂèëÈÄÅ
                }
            }
            
            updateMIDIStatus(connected) {
                if (connected) {
                    this.midiStatus.classList.add('connected');
                    this.midiStatusText.textContent = 'MIDIÂ∑≤ËøûÊé•';
                } else {
                    this.midiStatus.classList.remove('connected');
                    this.midiStatusText.textContent = 'MIDIÊñ≠ÂºÄ';
                }
            }
            
            scheduleReconnect() {
                // Â¶ÇÊûúË¢´Ë∏¢‰∏ãÁ∫øÔºå‰∏çÂÜçÂ∞ùËØïÈáçËøû
                if (this.isKickedOut) {
                    console.log('üö´ Â∑≤Ë¢´Ë∏¢‰∏ãÁ∫øÔºåÂÅúÊ≠¢ÈáçËøûÂ∞ùËØï');
                    return;
                }
                
                if (this.reconnectAttempts >= this.maxReconnectAttempts) {
                    console.log('ËææÂà∞ÊúÄÂ§ßÈáçËøûÊ¨°Êï∞ÔºåÂÅúÊ≠¢ÈáçËøû');
                    this.hideReconnectOverlay();
                    return;
                }
                
                this.showReconnectOverlay();
                this.reconnectAttempts++;
                
                setTimeout(() => {
                    if (!this.isKickedOut) { // ÂÜçÊ¨°Ê£ÄÊü•ÊòØÂê¶Ë¢´Ë∏¢‰∏ãÁ∫ø
                        console.log(`Á¨¨${this.reconnectAttempts}Ê¨°ÈáçËøûÂ∞ùËØï`);
                        this.initWebSocket();
                    }
                }, this.reconnectDelay * this.reconnectAttempts);
            }
            
            showReconnectOverlay() {
                this.reconnectOverlay.style.display = 'flex';
            }
            
            hideReconnectOverlay() {
                this.reconnectOverlay.style.display = 'none';
            }
            
            startHeartbeat() {
                setInterval(() => {
                    if (this.isConnected && this.ws.readyState === WebSocket.OPEN) {
                        this.ws.send(JSON.stringify({ type: 'ping' }));
                    }
                }, 30000); // 30ÁßíÂøÉË∑≥
            }
            
            updateSensitivityDisplay() {
                // Êõ¥Êñ∞ÊåâÈíÆ‰∏äÁöÑÁÅµÊïèÂ∫¶ÊòæÁ§∫
                this.pitchSensDisplay.textContent = this.pitchSensitivity.toFixed(1);
                this.modSensDisplay.textContent = this.modSensitivity.toFixed(1);
                
                // Êõ¥Êñ∞ÂºπÁ™ó‰∏≠ÁöÑÊòæÁ§∫
                this.pitchSensValue.textContent = this.pitchSensitivity.toFixed(1) + 'x';
                this.modSensValue.textContent = this.modSensitivity.toFixed(1) + 'x';
                
                // Êõ¥Êñ∞ÊªëÂùóÂÄº
                this.pitchSensSlider.value = this.pitchSensitivity;
                this.modSensSlider.value = this.modSensitivity;
                
                // Êõ¥Êñ∞ÊúâÊïàÂå∫ÂüüÊòæÁ§∫
                this.updateActiveArea();
            }
            
            updateActiveArea() {
                // Êõ¥Êñ∞ÊúâÊïàËß¶Êë∏Âå∫ÂüüÊòæÁ§∫
                const rect = this.xyPad.getBoundingClientRect();
                const overlay = this.activeAreaOverlay;
                
                // ËÆ°ÁÆóÊúâÊïàÂå∫ÂüüÂ§ßÂ∞è
                // Ë∞ÉÂà∂Ôºö‰ªéÂ∑¶ËæπÁºòÂºÄÂßãÔºåÂÆΩÂ∫¶ÂèóË∞ÉÂà∂ÁÅµÊïèÂ∫¶ÂΩ±Âìç
                const effectiveWidth = rect.width / this.modSensitivity;
                
                // ÂºØÈü≥Ôºö‰ª•‰∏≠ÂøÉ‰∏∫Èõ∂ÁÇπÔºåÈ´òÂ∫¶ÂèóÂºØÈü≥ÁÅµÊïèÂ∫¶ÂΩ±Âìç
                const effectiveHeight = rect.height / this.pitchSensitivity;
                
                // ‰ΩçÁΩÆËÆ°ÁÆó
                const offsetX = 0; // ‰ªéÂ∑¶ËæπÁºòÂºÄÂßãÔºàÈõ∂ÁÇπ‰ΩçÁΩÆÔºâ
                const offsetY = (rect.height - effectiveHeight) / 2; // ÂûÇÁõ¥Â±Ö‰∏≠ÔºàÂºØÈü≥Èõ∂ÁÇπÂú®‰∏≠ÂøÉÔºâ
                
                // Á°Æ‰øù‰∏çË∂ÖÂá∫ËæπÁïå
                const clampedWidth = Math.min(effectiveWidth, rect.width);
                const clampedHeight = Math.min(effectiveHeight, rect.height);
                const clampedOffsetY = Math.max(0, Math.min(rect.height - clampedHeight, offsetY));
                
                overlay.style.left = offsetX + 'px';
                overlay.style.top = clampedOffsetY + 'px';
                overlay.style.width = clampedWidth + 'px';
                overlay.style.height = clampedHeight + 'px';
            }
            
            showSensitivityModal() {
                this.sensitivityModal.style.display = 'flex';
            }
            
            hideSensitivityModal() {
                this.sensitivityModal.style.display = 'none';
            }
            
            resetSensitivity() {
                this.pitchSensitivity = 1.0;
                this.modSensitivity = 1.0;
                this.updateSensitivityDisplay();
            }
            
            initEventListeners() {
                // ÁÅµÊïèÂ∫¶ÊåâÈíÆÂíåÂºπÁ™ó‰∫ã‰ª∂
                this.sensitivityButton.addEventListener('click', () => {
                    this.showSensitivityModal();
                });
                
                this.sensitivityButton.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    this.showSensitivityModal();
                }, { passive: false });
                
                // ÁÅµÊïèÂ∫¶ÊªëÂùó‰∫ã‰ª∂
                this.pitchSensSlider.addEventListener('input', (e) => {
                    this.pitchSensitivity = parseFloat(e.target.value);
                    this.updateSensitivityDisplay();
                });
                
                this.modSensSlider.addEventListener('input', (e) => {
                    this.modSensitivity = parseFloat(e.target.value);
                    this.updateSensitivityDisplay();
                });
                
                // ÂºπÁ™óÊåâÈíÆ‰∫ã‰ª∂
                this.resetSensButton.addEventListener('click', () => {
                    this.resetSensitivity();
                });
                
                this.closeSensButton.addEventListener('click', () => {
                    this.hideSensitivityModal();
                });
                
                // ÁÇπÂáªÂºπÁ™óËÉåÊôØÂÖ≥Èó≠
                this.sensitivityModal.addEventListener('click', (e) => {
                    if (e.target === this.sensitivityModal) {
                        this.hideSensitivityModal();
                    }
                });
                
                // Èº†Ê†á‰∫ã‰ª∂
                this.xyPad.addEventListener('mousedown', this.handleStart.bind(this));
                document.addEventListener('mousemove', this.handleMove.bind(this));
                document.addEventListener('mouseup', this.handleEnd.bind(this));
                document.addEventListener('mouseleave', this.handleEnd.bind(this)); // Èº†Ê†áÁ¶ªÂºÄÈ°µÈù¢
                
                // Ëß¶Êë∏‰∫ã‰ª∂
                this.xyPad.addEventListener('touchstart', this.handleStart.bind(this), { passive: false });
                document.addEventListener('touchmove', this.handleMove.bind(this), { passive: false });
                document.addEventListener('touchend', this.handleEnd.bind(this));
                document.addEventListener('touchcancel', this.handleEnd.bind(this)); // Ëß¶Êë∏Ë¢´ÂèñÊ∂à
                
                // È¢ùÂ§ñÁöÑÂÆâÂÖ®‰∫ã‰ª∂Â§ÑÁêÜ
                window.addEventListener('blur', this.forceReset.bind(this)); // Á™óÂè£Â§±ÁÑ¶
                window.addEventListener('beforeunload', () => {
                    this.stopContinuousSend(); // È°µÈù¢Âç∏ËΩΩÊó∂ÂÅúÊ≠¢ÊåÅÁª≠ÂèëÈÄÅ
                });
                document.addEventListener('visibilitychange', () => {
                    if (document.hidden) {
                        this.forceReset(); // È°µÈù¢Ë¢´ÈöêËóè
                        this.stopContinuousSend(); // ÂÅúÊ≠¢ÊåÅÁª≠ÂèëÈÄÅ
                    } else {
                        // È°µÈù¢ÈáçÊñ∞ÂèØËßÅÊó∂ÈáçÂêØÊåÅÁª≠ÂèëÈÄÅ
                        if (this.isConnected) {
                            this.startContinuousSend();
                        }
                    }
                });
                
                // ÂìçÂ∫îÁ™óÂè£Â§ßÂ∞èÂèòÂåñÔºåÊõ¥Êñ∞ÊúâÊïàÂå∫Âüü
                window.addEventListener('resize', () => {
                    setTimeout(() => this.updateActiveArea(), 100);
                });
                
                // Èò≤Ê≠¢È°µÈù¢ÊªöÂä®ÂíåÁº©Êîæ
                document.addEventListener('touchstart', (e) => {
                    // ÂÖÅËÆ∏Âú®ÂºπÁ™óÂÜÖËøõË°åËß¶Êë∏Êìç‰Ωú
                    if (!e.target.closest('.sensitivity-modal')) {
                        e.preventDefault();
                    }
                }, { passive: false });
                document.addEventListener('touchmove', (e) => {
                    // ÂÖÅËÆ∏Âú®ÂºπÁ™óÂÜÖËøõË°åËß¶Êë∏Êìç‰Ωú
                    if (!e.target.closest('.sensitivity-modal')) {
                        e.preventDefault();
                    }
                }, { passive: false });
                
                // Ê∑ªÂä†ÂÆöÊó∂Âô®Ê£ÄÊü•ÔºåÈò≤Ê≠¢ÂΩíÈõ∂Â§±Êïà
                setInterval(this.checkAndReset.bind(this), 100); // ÊØè100msÊ£ÄÊü•‰∏ÄÊ¨°
            }
            
            handleStart(event) {
                event.preventDefault();
                
                // Èò≤Ê≠¢Â§öËß¶ÁÇπÂÜ≤Á™Å
                if (this.isTracking) {
                    this.forceReset();
                }
                
                this.isTracking = true;
                this.touchIndicator.classList.add('active');
                this.lastTouchTime = Date.now();
                this.handleMove(event);
                
                if (this.isConnected) {
                    console.log('üéØ ÂºÄÂßãËß¶Êéß');
                }
            }
            
            handleMove(event) {
                if (!this.isTracking) return;
                
                event.preventDefault();
                this.lastTouchTime = Date.now(); // Êõ¥Êñ∞ÊúÄÂêéËß¶Êë∏Êó∂Èó¥
                
                // Ëé∑ÂèñËß¶Êë∏ÊàñÈº†Ê†á‰ΩçÁΩÆ
                let clientX, clientY;
                if (event.type.startsWith('touch')) {
                    if (event.touches.length === 0) return;
                    clientX = event.touches[0].clientX;
                    clientY = event.touches[0].clientY;
                } else {
                    clientX = event.clientX;
                    clientY = event.clientY;
                }
                
                // Ëé∑ÂèñÊéßÂà∂ÊùøËæπÁïå
                const rect = this.xyPad.getBoundingClientRect();
                
                // ËÆ°ÁÆóÁõ∏ÂØπ‰ΩçÁΩÆ
                let x = clientX - rect.left;
                let y = clientY - rect.top;
                
                // ËæπÁïåÁ∫¶ÊùüÔºöÂ¶ÇÊûúË∂ÖÂá∫ËåÉÂõ¥ÔºåÁ∫¶ÊùüÂà∞ÊúÄËøëÁöÑËæπÁïåÁÇπ
                x = Math.max(0, Math.min(rect.width, x));
                y = Math.max(0, Math.min(rect.height, y));
                
                // ËÆ°ÁÆóÂΩí‰∏ÄÂåñÂÄº (0-1)
                const normalizedX = x / rect.width;
                const normalizedY = 1 - (y / rect.height); // 0-1, ÁøªËΩ¨YËΩ¥
                
                // Èõ∂ÁÇπ‰ΩçÁΩÆÔºöXËΩ¥Â∑¶ËæπÁºò(0)ÔºåYËΩ¥‰∏≠ÂøÉ(0.5)
                // Ë∞ÉÂà∂Ôºö‰ªéÂ∑¶ËæπÁºò0ÂºÄÂßãÔºåÂêëÂè≥Â¢ûÂä†
                const modulation = Math.max(0, Math.min(1, normalizedX * this.modSensitivity));
                
                // ÂºØÈü≥Ôºö‰ª•ÂûÇÁõ¥‰∏≠ÂøÉ‰∏∫Èõ∂ÁÇπÔºå‰∏ä‰∏ãÂØπÁß∞
                const pitchDelta = (normalizedY - 0.5) * this.pitchSensitivity; // Áõ∏ÂØπ‰∫é‰∏≠ÂøÉÁöÑÂÅèÁßª
                const pitchbend = Math.max(-1, Math.min(1, pitchDelta * 2)); // Á∫¶ÊùüÂà∞ [-1, 1]
                
                this.currentPitchbend = pitchbend;
                this.currentModulation = modulation;
                
                // Á´ãÂç≥Êõ¥Êñ∞ÁïåÈù¢ÂíåÂèëÈÄÅÊï∞ÊçÆÔºàÈùûÊåÅÁª≠ÂèëÈÄÅÔºâ
                this.updateDisplay();
                this.updateTouchIndicator(x, y);
                this.sendControlData(false); // Ëß¶Êë∏ÁßªÂä®Êó∂Á´ãÂç≥ÂèëÈÄÅ
            }
            
            handleEnd(event) {
                if (!this.isTracking) return;
                
                event.preventDefault();
                console.log('üîÑ Ëß¶ÊéßÁªìÊùüÔºåÂºÄÂßãÂΩíÈõ∂');
                
                this.performReset();
            }
            
            forceReset() {
                console.log('‚ö†Ô∏è Âº∫Âà∂ÂΩíÈõ∂');
                this.performReset();
            }
            
            performReset() {
                // ÊâßË°åÂΩíÈõ∂Êìç‰Ωú
                this.isTracking = false;
                this.touchIndicator.classList.remove('active');
                
                // ÂΩíÈõ∂Êï∞ÂÄº
                this.currentPitchbend = 0;
                this.currentModulation = 0;
                
                // Êõ¥Êñ∞ÁïåÈù¢
                this.updateDisplay();
                
                // Á´ãÂç≥ÂèëÈÄÅÂΩíÈõ∂Êï∞ÊçÆÔºàÂ§öÊ¨°ÂèëÈÄÅÁ°Æ‰øùÊàêÂäüÔºåÈùûÊåÅÁª≠ÂèëÈÄÅÔºâ
                this.sendControlData(false);
                setTimeout(() => this.sendControlData(false), 10);  // 10msÂêéÂÜçÂèëÈÄÅ‰∏ÄÊ¨°
                setTimeout(() => this.sendControlData(false), 50);  // 50msÂêéÂÜçÂèëÈÄÅ‰∏ÄÊ¨°
                
                console.log('‚úÖ ÂΩíÈõ∂ÂÆåÊàê');
            }
            
            checkAndReset() {
                // ÂÆöÊó∂Ê£ÄÊü•ÔºöÂ¶ÇÊûúË∂ÖËøá200msÊ≤°ÊúâËß¶Êë∏Ê¥ªÂä®‰∏î‰∏çÂú®Ë∑üË∏™Áä∂ÊÄÅÔºåÁ°Æ‰øùÂ∑≤ÂΩíÈõ∂
                if (!this.isTracking && this.lastTouchTime && (Date.now() - this.lastTouchTime > 200)) {
                    if (Math.abs(this.currentPitchbend) > 0.001 || this.currentModulation > 0.001) {
                        console.log('‚ö†Ô∏è Ê£ÄÊµãÂà∞Êú™ÂΩíÈõ∂ÔºåÊâßË°åÂº∫Âà∂ÂΩíÈõ∂');
                        this.currentPitchbend = 0;
                        this.currentModulation = 0;
                        this.updateDisplay();
                        this.sendControlData(false); // Âº∫Âà∂ÂΩíÈõ∂Êó∂Á´ãÂç≥ÂèëÈÄÅ
                    }
                    this.lastTouchTime = null;
                }
            }
            
            updateTouchIndicator(x, y) {
                this.touchIndicator.style.left = x + 'px';
                this.touchIndicator.style.top = y + 'px';
            }
            
            updateDisplay() {
                // Êõ¥Êñ∞ÂºØÈü≥ÊòæÁ§∫
                const pitchStr = this.currentPitchbend >= 0 ? 
                    `+${this.currentPitchbend.toFixed(3)}` : 
                    this.currentPitchbend.toFixed(3);
                this.pitchValue.textContent = pitchStr;
                
                // Êõ¥Êñ∞Ë∞ÉÂà∂ÊòæÁ§∫
                const modMIDI = Math.round(this.currentModulation * 127);
                this.modValue.textContent = modMIDI.toString();
                
                // Âç≥Êó∂È¢úËâ≤ÂèçÈ¶àÔºàÊó†ËøáÊ∏°ÊïàÊûúÔºâ
                const pitchIntensity = Math.abs(this.currentPitchbend);
                const modIntensity = this.currentModulation;
                
                this.pitchValue.style.background = `rgba(255, ${Math.round(255 - pitchIntensity * 100)}, ${Math.round(255 - pitchIntensity * 100)}, 0.3)`;
                this.modValue.style.background = `rgba(${Math.round(255 - modIntensity * 100)}, 255, ${Math.round(255 - modIntensity * 100)}, 0.3)`;
            }
            
            sendControlData(isContinuous = false) {
                if (!this.isConnected || this.ws.readyState !== WebSocket.OPEN) {
                    if (!isContinuous) { // Âè™Âú®ÈùûÊåÅÁª≠ÂèëÈÄÅÊó∂ÊòæÁ§∫Ë≠¶Âëä
                        console.warn('‚ö†Ô∏è WebSocketÊú™ËøûÊé•ÔºåÊó†Ê≥ïÂèëÈÄÅÊï∞ÊçÆ');
                    }
                    return;
                }
                
                const data = {
                    type: 'control',
                    pitchbend: this.currentPitchbend,
                    modulation: this.currentModulation,
                    continuous: isContinuous, // Ê†áËÆ∞ÊòØÂê¶‰∏∫ÊåÅÁª≠ÂèëÈÄÅ
                    pitchSensitivity: this.pitchSensitivity, // ÂèëÈÄÅÂºØÈü≥ÁÅµÊïèÂ∫¶‰ø°ÊÅØ
                    modSensitivity: this.modSensitivity // ÂèëÈÄÅË∞ÉÂà∂ÁÅµÊïèÂ∫¶‰ø°ÊÅØ
                };
                
                try {
                    this.ws.send(JSON.stringify(data));
                    
                    // Ë∞ÉËØï‰ø°ÊÅØ - Âè™Âú®Ëß¶Êë∏Êìç‰ΩúÊàñÂΩíÈõ∂Êó∂ÊòæÁ§∫
                    if (!isContinuous) {
                        if (Math.abs(this.currentPitchbend) < 0.001 && this.currentModulation < 0.001) {
                            console.log('üîÑ ÂèëÈÄÅÂΩíÈõ∂Êï∞ÊçÆ:', data);
                        }
                    }
                } catch (e) {
                    if (!isContinuous) {
                        console.error('‚ùå ÂèëÈÄÅÊï∞ÊçÆÈîôËØØ:', e);
                        
                        // Â¶ÇÊûúÂèëÈÄÅÂ§±Ë¥•ÔºåÂ∞ùËØïÈáçÊñ∞ËøûÊé•
                        if (this.ws.readyState !== WebSocket.OPEN) {
                            this.scheduleReconnect();
                        }
                    }
                }
            }
        }
        
        // È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', () => {
            new MIDIController();
        });
        
        // Èò≤Ê≠¢È°µÈù¢Âà∑Êñ∞Êó∂ÁöÑÁ°ÆËÆ§ÂØπËØùÊ°Ü
        window.addEventListener('beforeunload', (e) => {
            e.preventDefault();
        });
        
        // ‰øùÊåÅÂ±èÂπïÂî§ÈÜíÔºàÂ¶ÇÊûúÊîØÊåÅÔºâ
        if ('wakeLock' in navigator) {
            navigator.wakeLock.request('screen').catch((err) => {
                console.log('Êó†Ê≥ïËé∑ÂèñÂ±èÂπïÂî§ÈÜíÈîÅ:', err.name, err.message);
            });
        }
    </script>
</body>
</html>