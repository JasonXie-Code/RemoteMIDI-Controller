<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ğŸ¹ Mobile MIDI Controller</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            height: 100vh;
            overflow: hidden;
            touch-action: none;
        }

        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            padding: 10px;
        }

        .header {
            text-align: center;
            padding: 10px 0;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .title {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .sensitivity-button {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            cursor: pointer;
            margin: 5px 0;
            transition: all 0.2s ease;
            -webkit-tap-highlight-color: transparent;
        }

        .sensitivity-button:hover,
        .sensitivity-button:active {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(0.98);
        }

        .status {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            font-size: 0.9em;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #ff4444;
        }

        .status-dot.connected {
            background: #44ff44;
            box-shadow: 0 0 10px #44ff44;
        }

        .control-area {
            flex: 1;
            display: flex;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 15px;
            overflow: hidden;
            position: relative;
        }

        .left-margin {
            width: 25%;
            background: rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 20px;
            position: relative;
            border-right: 2px solid rgba(255, 255, 255, 0.6);
        }

        .left-margin::after {
            content: '';
            position: absolute;
            top: 50%;
            right: -2px;
            width: 2px;
            height: 60%;
            background: rgba(255, 255, 255, 0.5);
            transform: translateY(-50%);
        }

        .margin-label {
            writing-mode: vertical-rl;
            text-orientation: mixed;
            font-size: 0.8em;
            opacity: 0.7;
            text-align: center;
        }

        .xy-pad {
            flex: 1;
            position: relative;
            background: linear-gradient(to bottom, 
                rgba(255, 100, 100, 0.3) 0%, 
                rgba(255, 255, 255, 0.1) 50%, 
                rgba(100, 255, 100, 0.3) 100%);
            cursor: crosshair;
            touch-action: none;
        }

        .xy-pad::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 2px;
            background: rgba(255, 255, 255, 0.5);
            transform: translateY(-1px);
        }

        .xy-pad::after {
            content: '';
            position: absolute;
            top: 0;
            bottom: 0;
            left: 0;
            width: 2px;
            background: rgba(255, 255, 255, 0.3);
        }

        .active-area-overlay {
            position: absolute;
            border: 2px solid rgba(255, 255, 255, 0.6);
            border-radius: 8px;
            pointer-events: none;
            transition: all 0.2s ease;
            background: rgba(255, 255, 255, 0.05);
        }

        .touch-indicator {
            position: absolute;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.8);
            border: 3px solid rgba(255, 255, 255, 0.5);
            transform: translate(-50%, -50%);
            pointer-events: none;
            display: none;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.6);
        }

        .touch-indicator.active {
            display: block;
            background: rgba(255, 255, 255, 1);
            box-shadow: 0 0 30px rgba(255, 255, 255, 0.8);
        }

        .values-display {
            padding: 15px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 10px;
            margin-top: 10px;
        }

        .value-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-family: 'Courier New', monospace;
        }

        .value-row:last-child {
            margin-bottom: 0;
        }

        .value-label {
            font-weight: bold;
            font-size: 0.9em;
        }

        .value-number {
            font-size: 1.1em;
            padding: 2px 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 5px;
            min-width: 80px;
            text-align: center;
        }

        .pitchbend {
            color: #ffaaaa;
        }

        .modulation {
            color: #aaffaa;
        }

        .sensitivity-display {
            color: #aaaaff;
        }

        /* çµæ•åº¦è®¾ç½®å¼¹çª— */
        .sensitivity-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1500;
        }

        .sensitivity-modal-content {
            background: rgba(20, 20, 40, 0.95);
            border-radius: 15px;
            padding: 25px;
            max-width: 350px;
            width: 90%;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .modal-title {
            text-align: center;
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 20px;
            color: white;
        }

        .sensitivity-control-group {
            margin-bottom: 25px;
        }

        .sensitivity-control-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            font-size: 0.95em;
            font-weight: bold;
        }

        .sensitivity-control-value {
            background: rgba(255, 255, 255, 0.2);
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.9em;
            min-width: 50px;
            text-align: center;
        }

        .sensitivity-control-slider {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 5px;
            outline: none;
            -webkit-appearance: none;
        }

        .sensitivity-control-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }

        .sensitivity-control-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            cursor: pointer;
            border: none;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }

        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 25px;
        }

        .modal-button {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            min-width: 80px;
            transition: all 0.2s ease;
            -webkit-tap-highlight-color: transparent;
        }

        .modal-button.primary {
            background: #007acc;
            color: white;
        }

        .modal-button.primary:hover,
        .modal-button.primary:active {
            background: #005c8a;
            transform: scale(0.98);
        }

        .modal-button.secondary {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .modal-button.secondary:hover,
        .modal-button.secondary:active {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(0.98);
        }

        .reconnect-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .reconnect-message {
            background: rgba(255, 255, 255, 0.1);
            padding: 30px;
            border-radius: 15px;
            text-align: center;
        }

        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 480px) {
            .container {
                padding: 5px;
            }
            
            .title {
                font-size: 1.2em;
            }
            
            .status {
                padding: 0 10px;
                font-size: 0.8em;
            }
            
            .left-margin {
                padding: 10px;
            }
            
            .values-display {
                padding: 10px;
            }

            .sensitivity-modal-content {
                padding: 20px;
                max-width: 320px;
            }
        }

        /* æ¨ªå±è­¦å‘Š */
        @media (orientation: landscape) {
            .landscape-warning {
                display: block;
            }
        }

        .landscape-warning {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            text-align: center;
            padding: 50px 20px;
            z-index: 2000;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="title">ğŸ¹ Mobile MIDI Controller</div>
            <button class="sensitivity-button" id="sensitivityButton">
                çµæ•åº¦è®¾ç½® (å¼¯éŸ³: <span id="pitchSensDisplay">1.0</span>x, è°ƒåˆ¶: <span id="modSensDisplay">1.0</span>x)
            </button>
            <div class="status">
                <div class="status-item">
                    <div class="status-dot" id="wsStatus"></div>
                    <span id="wsStatusText">è¿æ¥ä¸­...</span>
                </div>
                <div class="status-item">
                    <div class="status-dot" id="midiStatus"></div>
                    <span id="midiStatusText">MIDI</span>
                </div>
            </div>
        </div>

        <div class="control-area">
            <div class="left-margin">
                <div class="margin-label">è§¦æ§åŒºåŸŸ</div>
            </div>
            <div class="xy-pad" id="xyPad">
                <div class="active-area-overlay" id="activeAreaOverlay"></div>
                <div class="touch-indicator" id="touchIndicator"></div>
            </div>
        </div>

        <div class="values-display">
            <div class="value-row">
                <span class="value-label">å¼¯éŸ³ (Pitchbend):</span>
                <span class="value-number pitchbend" id="pitchValue">+0.000</span>
            </div>
            <div class="value-row">
                <span class="value-label">è°ƒåˆ¶ (Modulation):</span>
                <span class="value-number modulation" id="modValue">0</span>
            </div>
        </div>
    </div>

    <!-- çµæ•åº¦è®¾ç½®å¼¹çª— -->
    <div class="sensitivity-modal" id="sensitivityModal">
        <div class="sensitivity-modal-content">
            <div class="modal-title">ğŸ›ï¸ çµæ•åº¦è®¾ç½®</div>
            
            <div class="sensitivity-control-group">
                <div class="sensitivity-control-label">
                    <span>ğŸµ å¼¯éŸ³çµæ•åº¦</span>
                    <span class="sensitivity-control-value" id="pitchSensValue">1.0x</span>
                </div>
                <input type="range" class="sensitivity-control-slider" id="pitchSensSlider" 
                       min="0.5" max="2.0" step="0.1" value="1.0">
            </div>

            <div class="sensitivity-control-group">
                <div class="sensitivity-control-label">
                    <span>ğŸŒŠ è°ƒåˆ¶çµæ•åº¦</span>
                    <span class="sensitivity-control-value" id="modSensValue">1.0x</span>
                </div>
                <input type="range" class="sensitivity-control-slider" id="modSensSlider" 
                       min="0.5" max="2.0" step="0.1" value="1.0">
            </div>

            <div class="modal-buttons">
                <button class="modal-button secondary" id="resetSensButton">é‡ç½®</button>
                <button class="modal-button primary" id="closeSensButton">ç¡®å®š</button>
            </div>
        </div>
    </div>

    <div class="reconnect-overlay" id="reconnectOverlay">
        <div class="reconnect-message">
            <div class="spinner"></div>
            <div>é‡æ–°è¿æ¥ä¸­...</div>
        </div>
    </div>

    <div class="landscape-warning">
        <h2>ğŸ“± è¯·ç«–å±ä½¿ç”¨</h2>
        <p>ä¸ºäº†æœ€ä½³ä½“éªŒï¼Œè¯·å°†æ‰‹æœºç«–ç›´æ”¾ç½®ä½¿ç”¨æ­¤MIDIæ§åˆ¶å™¨</p>
    </div>

    <script>
        class MIDIController {
            constructor() {
                this.ws = null;
                this.isConnected = false;
                this.reconnectAttempts = 0;
                this.maxReconnectAttempts = 5;
                this.reconnectDelay = 1000;
                this.isKickedOut = false; // æ ‡è®°æ˜¯å¦è¢«è¸¢ä¸‹çº¿
                
                this.currentPitchbend = 0;
                this.currentModulation = 0;
                this.pitchSensitivity = 1.0; // å¼¯éŸ³çµæ•åº¦ï¼ŒèŒƒå›´ 0.5-2.0
                this.modSensitivity = 1.0;   // è°ƒåˆ¶çµæ•åº¦ï¼ŒèŒƒå›´ 0.5-2.0
                this.isTracking = false;
                this.lastTouchTime = null; // ä¸Šæ¬¡è§¦æ‘¸æ—¶é—´
                
                this.lastSendTime = 0;
                this.sendThrottle = 8; // ~120fps, æ›´å¿«å“åº”
                
                // æŒç»­å‘é€å®šæ—¶å™¨
                this.continuousSendInterval = null;
                this.continuousSendRate = 50; // 20fpsæŒç»­å‘é€
                
                this.xyPad = document.getElementById('xyPad');
                this.touchIndicator = document.getElementById('touchIndicator');
                this.activeAreaOverlay = document.getElementById('activeAreaOverlay');
                
                this.initElements();
                this.initWebSocket();
                this.initEventListeners();
                this.startHeartbeat();
                this.startContinuousSend(); // å¯åŠ¨æŒç»­å‘é€
                this.updateActiveArea(); // åˆå§‹åŒ–æœ‰æ•ˆåŒºåŸŸæ˜¾ç¤º
                this.updateSensitivityDisplay(); // åˆå§‹åŒ–çµæ•åº¦æ˜¾ç¤º
            }
            
            initElements() {
                this.wsStatus = document.getElementById('wsStatus');
                this.wsStatusText = document.getElementById('wsStatusText');
                this.midiStatus = document.getElementById('midiStatus');
                this.midiStatusText = document.getElementById('midiStatusText');
                this.pitchValue = document.getElementById('pitchValue');
                this.modValue = document.getElementById('modValue');
                this.reconnectOverlay = document.getElementById('reconnectOverlay');
                
                // çµæ•åº¦ç›¸å…³å…ƒç´ 
                this.sensitivityButton = document.getElementById('sensitivityButton');
                this.sensitivityModal = document.getElementById('sensitivityModal');
                this.pitchSensSlider = document.getElementById('pitchSensSlider');
                this.modSensSlider = document.getElementById('modSensSlider');
                this.pitchSensValue = document.getElementById('pitchSensValue');
                this.modSensValue = document.getElementById('modSensValue');
                this.pitchSensDisplay = document.getElementById('pitchSensDisplay');
                this.modSensDisplay = document.getElementById('modSensDisplay');
                this.resetSensButton = document.getElementById('resetSensButton');
                this.closeSensButton = document.getElementById('closeSensButton');
            }
            
            initWebSocket() {
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${protocol}//${window.location.hostname}:8001`;
                
                console.log('è¿æ¥WebSocket:', wsUrl);
                this.ws = new WebSocket(wsUrl);
                
                this.ws.onopen = () => {
                    console.log('WebSocketè¿æ¥æˆåŠŸ');
                    this.isConnected = true;
                    this.reconnectAttempts = 0;
                    this.updateConnectionStatus(true);
                    this.hideReconnectOverlay();
                    
                    // è¿æ¥æˆåŠŸåç«‹å³å¯åŠ¨æŒç»­å‘é€
                    this.startContinuousSend();
                };
                
                this.ws.onclose = () => {
                    console.log('WebSocketè¿æ¥å…³é—­');
                    this.isConnected = false;
                    this.updateConnectionStatus(false);
                    this.stopContinuousSend(); // è¿æ¥å…³é—­æ—¶åœæ­¢æŒç»­å‘é€
                    this.scheduleReconnect();
                };
                
                this.ws.onerror = (error) => {
                    console.error('WebSocketé”™è¯¯:', error);
                    this.isConnected = false;
                    this.updateConnectionStatus(false);
                    this.stopContinuousSend(); // è¿æ¥å‡ºé”™æ—¶åœæ­¢æŒç»­å‘é€
                };
                
                this.ws.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        this.handleMessage(data);
                    } catch (e) {
                        console.error('æ¶ˆæ¯è§£æé”™è¯¯:', e);
                    }
                };
            }
            
            handleMessage(data) {
                switch (data.type) {
                    case 'status':
                        this.updateMIDIStatus(data.data.midi_connected);
                        break;
                    case 'pong':
                        // å¿ƒè·³å“åº”
                        break;
                    case 'disconnect':
                        // è¢«æœåŠ¡å™¨è¸¢ä¸‹çº¿
                        console.log('âš ï¸ è¢«æ–°è®¾å¤‡è¸¢ä¸‹çº¿:', data.reason);
                        this.isKickedOut = true; // æ ‡è®°è¢«è¸¢ä¸‹çº¿ï¼Œåœæ­¢é‡è¿
                        this.stopContinuousSend(); // åœæ­¢æŒç»­å‘é€
                        this.showKickedMessage(data.reason);
                        break;
                }
            }
            
            showKickedMessage(reason) {
                // æ˜¾ç¤ºè¢«è¸¢ä¸‹çº¿çš„æ¶ˆæ¯
                const overlay = document.createElement('div');
                overlay.style.cssText = `
                    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                    background: rgba(0,0,0,0.8); color: white; z-index: 9999;
                    display: flex; align-items: center; justify-content: center;
                    font-size: 18px; text-align: center; padding: 20px;
                    -webkit-user-select: none; user-select: none;
                `;
                overlay.innerHTML = `
                    <div style="max-width: 300px;">
                        <h3 style="margin-bottom: 15px;">âš ï¸ è¿æ¥å·²æ–­å¼€</h3>
                        <p style="margin-bottom: 15px;">${reason}</p>
                        <p style="margin: 20px 0; font-size: 14px; color: #ccc; line-height: 1.4;">
                            åªæœ‰æœ€æ–°è¿æ¥çš„è®¾å¤‡å¯ä»¥æ§åˆ¶MIDI<br>
                            å¦‚éœ€é‡æ–°æ§åˆ¶ï¼Œè¯·ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®
                        </p>
                        <div style="margin-top: 25px;">
                            <button id="reconnectBtn" style="
                                padding: 15px 25px; font-size: 16px; 
                                background: #007acc; color: white; 
                                border: none; border-radius: 8px; 
                                cursor: pointer; margin: 0 8px;
                                min-height: 44px; min-width: 120px;
                                touch-action: manipulation;
                                -webkit-appearance: none;
                                -webkit-tap-highlight-color: rgba(0,0,0,0);
                            ">é‡æ–°è¿æ¥</button>
                            <button id="closeBtn" style="
                                padding: 15px 25px; font-size: 16px; 
                                background: #666; color: white; 
                                border: none; border-radius: 8px; 
                                cursor: pointer; margin: 0 8px;
                                min-height: 44px; min-width: 120px;
                                touch-action: manipulation;
                                -webkit-appearance: none;
                                -webkit-tap-highlight-color: rgba(0,0,0,0);
                            ">å…³é—­é¡µé¢</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(overlay);
                
                // ç­‰å¾…DOMæ¸²æŸ“å®Œæˆåç»‘å®šäº‹ä»¶
                setTimeout(() => {
                    const reconnectBtn = document.getElementById('reconnectBtn');
                    const closeBtn = document.getElementById('closeBtn');
                    
                    if (reconnectBtn) {
                        // é‡æ–°è¿æ¥æŒ‰é’® - æ”¯æŒç‚¹å‡»å’Œè§¦æ‘¸
                        const handleReconnect = (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            console.log('ğŸ”„ ç”¨æˆ·ç‚¹å‡»é‡æ–°è¿æ¥');
                            
                            this.isKickedOut = false; // é‡ç½®çŠ¶æ€
                            this.reconnectAttempts = 0; // é‡ç½®é‡è¿æ¬¡æ•°
                            document.body.removeChild(overlay);
                            this.initWebSocket(); // é‡æ–°è¿æ¥
                        };
                        
                        reconnectBtn.addEventListener('click', handleReconnect);
                        reconnectBtn.addEventListener('touchstart', handleReconnect, { passive: false });
                        reconnectBtn.addEventListener('touchend', (e) => {
                            e.preventDefault();
                        }, { passive: false });
                        
                        // æ·»åŠ è§†è§‰åé¦ˆ
                        reconnectBtn.addEventListener('touchstart', () => {
                            reconnectBtn.style.background = '#005c8a';
                        });
                        reconnectBtn.addEventListener('touchend', () => {
                            setTimeout(() => {
                                if (reconnectBtn.parentNode) {
                                    reconnectBtn.style.background = '#007acc';
                                }
                            }, 100);
                        });
                    }
                    
                    if (closeBtn) {
                        // å…³é—­é¡µé¢æŒ‰é’® - æ”¯æŒç‚¹å‡»å’Œè§¦æ‘¸
                        const handleClose = (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            console.log('âŒ ç”¨æˆ·é€‰æ‹©å…³é—­é¡µé¢');
                            
                            // å°è¯•å…³é—­çª—å£ï¼Œå¦‚æœå¤±è´¥åˆ™æ˜¾ç¤ºæç¤º
                            if (window.close) {
                                window.close();
                            }
                            
                            // å¦‚æœæ— æ³•å…³é—­çª—å£ï¼Œæ˜¾ç¤ºæç¤º
                            setTimeout(() => {
                                alert('è¯·æ‰‹åŠ¨å…³é—­æ­¤é¡µé¢');
                            }, 500);
                        };
                        
                        closeBtn.addEventListener('click', handleClose);
                        closeBtn.addEventListener('touchstart', handleClose, { passive: false });
                        closeBtn.addEventListener('touchend', (e) => {
                            e.preventDefault();
                        }, { passive: false });
                        
                        // æ·»åŠ è§†è§‰åé¦ˆ
                        closeBtn.addEventListener('touchstart', () => {
                            closeBtn.style.background = '#444';
                        });
                        closeBtn.addEventListener('touchend', () => {
                            setTimeout(() => {
                                if (closeBtn.parentNode) {
                                    closeBtn.style.background = '#666';
                                }
                            }, 100);
                        });
                    }
                }, 100);
            }
            
            startContinuousSend() {
                // å¯åŠ¨æŒç»­å‘é€å®šæ—¶å™¨
                if (this.continuousSendInterval) {
                    clearInterval(this.continuousSendInterval);
                }
                
                this.continuousSendInterval = setInterval(() => {
                    // æŒç»­å‘é€å½“å‰ä½ç½®ï¼Œæ— è®ºæ˜¯å¦æœ‰è§¦æ‘¸
                    this.sendControlData(true); // ä¼ å…¥trueè¡¨ç¤ºæ˜¯æŒç»­å‘é€
                }, this.continuousSendRate);
                
                console.log('ğŸ”„ å¯åŠ¨æŒç»­å‘é€å®šæ—¶å™¨ (20fps)');
            }
            
            stopContinuousSend() {
                if (this.continuousSendInterval) {
                    clearInterval(this.continuousSendInterval);
                    this.continuousSendInterval = null;
                    console.log('â„¹ï¸ åœæ­¢æŒç»­å‘é€å®šæ—¶å™¨');
                }
            }
            
            updateConnectionStatus(connected) {
                if (connected) {
                    this.wsStatus.classList.add('connected');
                    this.wsStatusText.textContent = 'å·²è¿æ¥';
                    this.startContinuousSend(); // è¿æ¥æ—¶å¯åŠ¨æŒç»­å‘é€
                } else {
                    this.wsStatus.classList.remove('connected');
                    this.wsStatusText.textContent = 'æ–­å¼€';
                    this.stopContinuousSend(); // æ–­å¼€æ—¶åœæ­¢æŒç»­å‘é€
                }
            }
            
            updateMIDIStatus(connected) {
                if (connected) {
                    this.midiStatus.classList.add('connected');
                    this.midiStatusText.textContent = 'MIDIå·²è¿æ¥';
                } else {
                    this.midiStatus.classList.remove('connected');
                    this.midiStatusText.textContent = 'MIDIæ–­å¼€';
                }
            }
            
            scheduleReconnect() {
                // å¦‚æœè¢«è¸¢ä¸‹çº¿ï¼Œä¸å†å°è¯•é‡è¿
                if (this.isKickedOut) {
                    console.log('ğŸš« å·²è¢«è¸¢ä¸‹çº¿ï¼Œåœæ­¢é‡è¿å°è¯•');
                    return;
                }
                
                if (this.reconnectAttempts >= this.maxReconnectAttempts) {
                    console.log('è¾¾åˆ°æœ€å¤§é‡è¿æ¬¡æ•°ï¼Œåœæ­¢é‡è¿');
                    this.hideReconnectOverlay();
                    return;
                }
                
                this.showReconnectOverlay();
                this.reconnectAttempts++;
                
                setTimeout(() => {
                    if (!this.isKickedOut) { // å†æ¬¡æ£€æŸ¥æ˜¯å¦è¢«è¸¢ä¸‹çº¿
                        console.log(`ç¬¬${this.reconnectAttempts}æ¬¡é‡è¿å°è¯•`);
                        this.initWebSocket();
                    }
                }, this.reconnectDelay * this.reconnectAttempts);
            }
            
            showReconnectOverlay() {
                this.reconnectOverlay.style.display = 'flex';
            }
            
            hideReconnectOverlay() {
                this.reconnectOverlay.style.display = 'none';
            }
            
            startHeartbeat() {
                setInterval(() => {
                    if (this.isConnected && this.ws.readyState === WebSocket.OPEN) {
                        this.ws.send(JSON.stringify({ type: 'ping' }));
                    }
                }, 30000); // 30ç§’å¿ƒè·³
            }
            
            updateSensitivityDisplay() {
                // æ›´æ–°æŒ‰é’®ä¸Šçš„çµæ•åº¦æ˜¾ç¤º
                this.pitchSensDisplay.textContent = this.pitchSensitivity.toFixed(1);
                this.modSensDisplay.textContent = this.modSensitivity.toFixed(1);
                
                // æ›´æ–°å¼¹çª—ä¸­çš„æ˜¾ç¤º
                this.pitchSensValue.textContent = this.pitchSensitivity.toFixed(1) + 'x';
                this.modSensValue.textContent = this.modSensitivity.toFixed(1) + 'x';
                
                // æ›´æ–°æ»‘å—å€¼
                this.pitchSensSlider.value = this.pitchSensitivity;
                this.modSensSlider.value = this.modSensitivity;
                
                // æ›´æ–°æœ‰æ•ˆåŒºåŸŸæ˜¾ç¤º
                this.updateActiveArea();
            }
            
            updateActiveArea() {
                // æ›´æ–°æœ‰æ•ˆè§¦æ‘¸åŒºåŸŸæ˜¾ç¤º
                const rect = this.xyPad.getBoundingClientRect();
                const overlay = this.activeAreaOverlay;
                
                // è®¡ç®—æœ‰æ•ˆåŒºåŸŸå¤§å°
                // è°ƒåˆ¶ï¼šä»å·¦è¾¹ç¼˜å¼€å§‹ï¼Œå®½åº¦å—è°ƒåˆ¶çµæ•åº¦å½±å“
                const effectiveWidth = rect.width / this.modSensitivity;
                
                // å¼¯éŸ³ï¼šä»¥ä¸­å¿ƒä¸ºé›¶ç‚¹ï¼Œé«˜åº¦å—å¼¯éŸ³çµæ•åº¦å½±å“
                const effectiveHeight = rect.height / this.pitchSensitivity;
                
                // ä½ç½®è®¡ç®—
                const offsetX = 0; // ä»å·¦è¾¹ç¼˜å¼€å§‹ï¼ˆé›¶ç‚¹ä½ç½®ï¼‰
                const offsetY = (rect.height - effectiveHeight) / 2; // å‚ç›´å±…ä¸­ï¼ˆå¼¯éŸ³é›¶ç‚¹åœ¨ä¸­å¿ƒï¼‰
                
                // ç¡®ä¿ä¸è¶…å‡ºè¾¹ç•Œ
                const clampedWidth = Math.min(effectiveWidth, rect.width);
                const clampedHeight = Math.min(effectiveHeight, rect.height);
                const clampedOffsetY = Math.max(0, Math.min(rect.height - clampedHeight, offsetY));
                
                overlay.style.left = offsetX + 'px';
                overlay.style.top = clampedOffsetY + 'px';
                overlay.style.width = clampedWidth + 'px';
                overlay.style.height = clampedHeight + 'px';
            }
            
            showSensitivityModal() {
                this.sensitivityModal.style.display = 'flex';
            }
            
            hideSensitivityModal() {
                this.sensitivityModal.style.display = 'none';
            }
            
            resetSensitivity() {
                this.pitchSensitivity = 1.0;
                this.modSensitivity = 1.0;
                this.updateSensitivityDisplay();
            }
            
            initEventListeners() {
                // çµæ•åº¦æŒ‰é’®å’Œå¼¹çª—äº‹ä»¶
                this.sensitivityButton.addEventListener('click', () => {
                    this.showSensitivityModal();
                });
                
                this.sensitivityButton.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    this.showSensitivityModal();
                }, { passive: false });
                
                // çµæ•åº¦æ»‘å—äº‹ä»¶
                this.pitchSensSlider.addEventListener('input', (e) => {
                    this.pitchSensitivity = parseFloat(e.target.value);
                    this.updateSensitivityDisplay();
                });
                
                this.modSensSlider.addEventListener('input', (e) => {
                    this.modSensitivity = parseFloat(e.target.value);
                    this.updateSensitivityDisplay();
                });
                
                // å¼¹çª—æŒ‰é’®äº‹ä»¶
                this.resetSensButton.addEventListener('click', () => {
                    this.resetSensitivity();
                });
                
                this.closeSensButton.addEventListener('click', () => {
                    this.hideSensitivityModal();
                });
                
                // ç‚¹å‡»å¼¹çª—èƒŒæ™¯å…³é—­
                this.sensitivityModal.addEventListener('click', (e) => {
                    if (e.target === this.sensitivityModal) {
                        this.hideSensitivityModal();
                    }
                });
                
                // é¼ æ ‡äº‹ä»¶
                this.xyPad.addEventListener('mousedown', this.handleStart.bind(this));
                document.addEventListener('mousemove', this.handleMove.bind(this));
                document.addEventListener('mouseup', this.handleEnd.bind(this));
                document.addEventListener('mouseleave', this.handleEnd.bind(this)); // é¼ æ ‡ç¦»å¼€é¡µé¢
                
                // è§¦æ‘¸äº‹ä»¶
                this.xyPad.addEventListener('touchstart', this.handleStart.bind(this), { passive: false });
                document.addEventListener('touchmove', this.handleMove.bind(this), { passive: false });
                document.addEventListener('touchend', this.handleEnd.bind(this));
                document.addEventListener('touchcancel', this.handleEnd.bind(this)); // è§¦æ‘¸è¢«å–æ¶ˆ
                
                // é¢å¤–çš„å®‰å…¨äº‹ä»¶å¤„ç†
                window.addEventListener('blur', this.forceReset.bind(this)); // çª—å£å¤±ç„¦
                window.addEventListener('beforeunload', () => {
                    this.stopContinuousSend(); // é¡µé¢å¸è½½æ—¶åœæ­¢æŒç»­å‘é€
                });
                document.addEventListener('visibilitychange', () => {
                    if (document.hidden) {
                        this.forceReset(); // é¡µé¢è¢«éšè—
                        this.stopContinuousSend(); // åœæ­¢æŒç»­å‘é€
                    } else {
                        // é¡µé¢é‡æ–°å¯è§æ—¶é‡å¯æŒç»­å‘é€
                        if (this.isConnected) {
                            this.startContinuousSend();
                        }
                    }
                });
                
                // å“åº”çª—å£å¤§å°å˜åŒ–ï¼Œæ›´æ–°æœ‰æ•ˆåŒºåŸŸ
                window.addEventListener('resize', () => {
                    setTimeout(() => this.updateActiveArea(), 100);
                });
                
                // é˜²æ­¢é¡µé¢æ»šåŠ¨å’Œç¼©æ”¾
                document.addEventListener('touchstart', (e) => {
                    // å…è®¸åœ¨å¼¹çª—å†…è¿›è¡Œè§¦æ‘¸æ“ä½œ
                    if (!e.target.closest('.sensitivity-modal')) {
                        e.preventDefault();
                    }
                }, { passive: false });
                document.addEventListener('touchmove', (e) => {
                    // å…è®¸åœ¨å¼¹çª—å†…è¿›è¡Œè§¦æ‘¸æ“ä½œ
                    if (!e.target.closest('.sensitivity-modal')) {
                        e.preventDefault();
                    }
                }, { passive: false });
                
                // æ·»åŠ å®šæ—¶å™¨æ£€æŸ¥ï¼Œé˜²æ­¢å½’é›¶å¤±æ•ˆ
                setInterval(this.checkAndReset.bind(this), 100); // æ¯100msæ£€æŸ¥ä¸€æ¬¡
            }
            
            handleStart(event) {
                event.preventDefault();
                
                // é˜²æ­¢å¤šè§¦ç‚¹å†²çª
                if (this.isTracking) {
                    this.forceReset();
                }
                
                this.isTracking = true;
                this.touchIndicator.classList.add('active');
                this.lastTouchTime = Date.now();
                this.handleMove(event);
                
                if (this.isConnected) {
                    console.log('ğŸ¯ å¼€å§‹è§¦æ§');
                }
            }
            
            handleMove(event) {
                if (!this.isTracking) return;
                
                event.preventDefault();
                this.lastTouchTime = Date.now(); // æ›´æ–°æœ€åè§¦æ‘¸æ—¶é—´
                
                // è·å–è§¦æ‘¸æˆ–é¼ æ ‡ä½ç½®
                let clientX, clientY;
                if (event.type.startsWith('touch')) {
                    if (event.touches.length === 0) return;
                    clientX = event.touches[0].clientX;
                    clientY = event.touches[0].clientY;
                } else {
                    clientX = event.clientX;
                    clientY = event.clientY;
                }
                
                // è·å–æ§åˆ¶æ¿è¾¹ç•Œ
                const rect = this.xyPad.getBoundingClientRect();
                
                // è®¡ç®—ç›¸å¯¹ä½ç½®
                let x = clientX - rect.left;
                let y = clientY - rect.top;
                
                // è¾¹ç•Œçº¦æŸï¼šå¦‚æœè¶…å‡ºèŒƒå›´ï¼Œçº¦æŸåˆ°æœ€è¿‘çš„è¾¹ç•Œç‚¹
                x = Math.max(0, Math.min(rect.width, x));
                y = Math.max(0, Math.min(rect.height, y));
                
                // è®¡ç®—å½’ä¸€åŒ–å€¼ (0-1)
                const normalizedX = x / rect.width;
                const normalizedY = 1 - (y / rect.height); // 0-1, ç¿»è½¬Yè½´
                
                // é›¶ç‚¹ä½ç½®ï¼šXè½´å·¦è¾¹ç¼˜(0)ï¼ŒYè½´ä¸­å¿ƒ(0.5)
                // è°ƒåˆ¶ï¼šä»å·¦è¾¹ç¼˜0å¼€å§‹ï¼Œå‘å³å¢åŠ 
                const modulation = Math.max(0, Math.min(1, normalizedX * this.modSensitivity));
                
                // å¼¯éŸ³ï¼šä»¥å‚ç›´ä¸­å¿ƒä¸ºé›¶ç‚¹ï¼Œä¸Šä¸‹å¯¹ç§°
                const pitchDelta = (normalizedY - 0.5) * this.pitchSensitivity; // ç›¸å¯¹äºä¸­å¿ƒçš„åç§»
                const pitchbend = Math.max(-1, Math.min(1, pitchDelta * 2)); // çº¦æŸåˆ° [-1, 1]
                
                this.currentPitchbend = pitchbend;
                this.currentModulation = modulation;
                
                // ç«‹å³æ›´æ–°ç•Œé¢å’Œå‘é€æ•°æ®ï¼ˆéæŒç»­å‘é€ï¼‰
                this.updateDisplay();
                this.updateTouchIndicator(x, y);
                this.sendControlData(false); // è§¦æ‘¸ç§»åŠ¨æ—¶ç«‹å³å‘é€
            }
            
            handleEnd(event) {
                if (!this.isTracking) return;
                
                event.preventDefault();
                console.log('ğŸ”„ è§¦æ§ç»“æŸï¼Œå¼€å§‹å½’é›¶');
                
                this.performReset();
            }
            
            forceReset() {
                console.log('âš ï¸ å¼ºåˆ¶å½’é›¶');
                this.performReset();
            }
            
            performReset() {
                // æ‰§è¡Œå½’é›¶æ“ä½œ
                this.isTracking = false;
                this.touchIndicator.classList.remove('active');
                
                // å½’é›¶æ•°å€¼
                this.currentPitchbend = 0;
                this.currentModulation = 0;
                
                // æ›´æ–°ç•Œé¢
                this.updateDisplay();
                
                // ç«‹å³å‘é€å½’é›¶æ•°æ®ï¼ˆå¤šæ¬¡å‘é€ç¡®ä¿æˆåŠŸï¼ŒéæŒç»­å‘é€ï¼‰
                this.sendControlData(false);
                setTimeout(() => this.sendControlData(false), 10);  // 10msåå†å‘é€ä¸€æ¬¡
                setTimeout(() => this.sendControlData(false), 50);  // 50msåå†å‘é€ä¸€æ¬¡
                
                console.log('âœ… å½’é›¶å®Œæˆ');
            }
            
            checkAndReset() {
                // å®šæ—¶æ£€æŸ¥ï¼šå¦‚æœè¶…è¿‡200msæ²¡æœ‰è§¦æ‘¸æ´»åŠ¨ä¸”ä¸åœ¨è·Ÿè¸ªçŠ¶æ€ï¼Œç¡®ä¿å·²å½’é›¶
                if (!this.isTracking && this.lastTouchTime && (Date.now() - this.lastTouchTime > 200)) {
                    if (Math.abs(this.currentPitchbend) > 0.001 || this.currentModulation > 0.001) {
                        console.log('âš ï¸ æ£€æµ‹åˆ°æœªå½’é›¶ï¼Œæ‰§è¡Œå¼ºåˆ¶å½’é›¶');
                        this.currentPitchbend = 0;
                        this.currentModulation = 0;
                        this.updateDisplay();
                        this.sendControlData(false); // å¼ºåˆ¶å½’é›¶æ—¶ç«‹å³å‘é€
                    }
                    this.lastTouchTime = null;
                }
            }
            
            updateTouchIndicator(x, y) {
                this.touchIndicator.style.left = x + 'px';
                this.touchIndicator.style.top = y + 'px';
            }
            
            updateDisplay() {
                // æ›´æ–°å¼¯éŸ³æ˜¾ç¤º
                const pitchStr = this.currentPitchbend >= 0 ? 
                    `+${this.currentPitchbend.toFixed(3)}` : 
                    this.currentPitchbend.toFixed(3);
                this.pitchValue.textContent = pitchStr;
                
                // æ›´æ–°è°ƒåˆ¶æ˜¾ç¤º
                const modMIDI = Math.round(this.currentModulation * 127);
                this.modValue.textContent = modMIDI.toString();
                
                // å³æ—¶é¢œè‰²åé¦ˆï¼ˆæ— è¿‡æ¸¡æ•ˆæœï¼‰
                const pitchIntensity = Math.abs(this.currentPitchbend);
                const modIntensity = this.currentModulation;
                
                this.pitchValue.style.background = `rgba(255, ${Math.round(255 - pitchIntensity * 100)}, ${Math.round(255 - pitchIntensity * 100)}, 0.3)`;
                this.modValue.style.background = `rgba(${Math.round(255 - modIntensity * 100)}, 255, ${Math.round(255 - modIntensity * 100)}, 0.3)`;
            }
            
            sendControlData(isContinuous = false) {
                if (!this.isConnected || this.ws.readyState !== WebSocket.OPEN) {
                    if (!isContinuous) { // åªåœ¨éæŒç»­å‘é€æ—¶æ˜¾ç¤ºè­¦å‘Š
                        console.warn('âš ï¸ WebSocketæœªè¿æ¥ï¼Œæ— æ³•å‘é€æ•°æ®');
                    }
                    return;
                }
                
                const data = {
                    type: 'control',
                    pitchbend: this.currentPitchbend,
                    modulation: this.currentModulation,
                    continuous: isContinuous, // æ ‡è®°æ˜¯å¦ä¸ºæŒç»­å‘é€
                    pitchSensitivity: this.pitchSensitivity, // å‘é€å¼¯éŸ³çµæ•åº¦ä¿¡æ¯
                    modSensitivity: this.modSensitivity // å‘é€è°ƒåˆ¶çµæ•åº¦ä¿¡æ¯
                };
                
                try {
                    this.ws.send(JSON.stringify(data));
                    
                    // è°ƒè¯•ä¿¡æ¯ - åªåœ¨è§¦æ‘¸æ“ä½œæˆ–å½’é›¶æ—¶æ˜¾ç¤º
                    if (!isContinuous) {
                        if (Math.abs(this.currentPitchbend) < 0.001 && this.currentModulation < 0.001) {
                            console.log('ğŸ”„ å‘é€å½’é›¶æ•°æ®:', data);
                        }
                    }
                } catch (e) {
                    if (!isContinuous) {
                        console.error('âŒ å‘é€æ•°æ®é”™è¯¯:', e);
                        
                        // å¦‚æœå‘é€å¤±è´¥ï¼Œå°è¯•é‡æ–°è¿æ¥
                        if (this.ws.readyState !== WebSocket.OPEN) {
                            this.scheduleReconnect();
                        }
                    }
                }
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            new MIDIController();
        });
        
        // é˜²æ­¢é¡µé¢åˆ·æ–°æ—¶çš„ç¡®è®¤å¯¹è¯æ¡†
        window.addEventListener('beforeunload', (e) => {
            e.preventDefault();
        });
        
        // ä¿æŒå±å¹•å”¤é†’ï¼ˆå¦‚æœæ”¯æŒï¼‰
        if ('wakeLock' in navigator) {
            navigator.wakeLock.request('screen').catch((err) => {
                console.log('æ— æ³•è·å–å±å¹•å”¤é†’é”:', err.name, err.message);
            });
        }
    </script>
</body>
</html>